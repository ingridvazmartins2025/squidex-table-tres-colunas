<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Tabela Interativa Squidex</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="./editor-sdk.js"></script>
  <style>
    body {
      font-family: "Inter", sans-serif;
      margin: 20px;
      background-color: #f8fafc;
    }

    h2 {
      color: #1e3a8a;
      margin-bottom: 16px;
    }

    .controls {
      margin-bottom: 12px;
    }

    button {
      background-color: #2563eb;
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 6px;
      margin-right: 6px;
      cursor: pointer;
    }

    button:hover {
      background-color: #1d4ed8;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      border: 1px solid #d1d5db;
      background-color: white;
      border-radius: 8px;
      overflow: hidden;
    }

    thead {
      background-color: #e8f0ff;
      color: #1e3a8a;
    }

    th, td {
      border: 1px solid #d1d5db;
      padding: 8px;
      text-align: left;
    }

    th {
      font-weight: 600;
      cursor: pointer;
      position: relative;
    }

    th input {
      width: 95%;
      border: none;
      background: transparent;
      font-weight: 600;
      color: #1e3a8a;
      cursor: text;
    }

    th input:focus {
      outline: none;
      background-color: #dbeafe;
    }

    td input {
      width: 100%;
      border: none;
      background: transparent;
      color: #111827;
    }

    td input:focus {
      outline: none;
      background-color: #eef2ff;
    }

    tr:nth-child(even) {
      background-color: #f9fafb;
    }

    th.sort-asc::after {
      content: " ⬆️";
    }

    th.sort-desc::after {
      content: " ⬇️";
    }
  </style>
</head>
<body>
  <h2>Tabela Interativa (Squidex)</h2>
  <div class="controls">
    <button id="addColumn">Adicionar Coluna</button>
    <button id="addRow">Adicionar Linha</button>
    <button id="clearTable">Limpar Tudo</button>
  </div>

  <div id="tableContainer"></div>

  <script>
    let field;
    try { field = new SquidexFormField(); } catch (e) { console.warn("Rodando fora do Squidex"); }

    let tableData = {
      headers: ["ID", "Nome", "E-mail", "Departamento", "Data de Criação"],
      rows: [
        { c1: "101", c2: "Ana Silva", c3: "ana.silva@empresa.com", c4: "Financeiro", c5: "2024-05-12" },
        { c1: "102", c2: "Bruno Costa", c3: "bruno.costa@empresa.com", c4: "Marketing", c5: "2024-06-03" },
        { c1: "103", c2: "Carla Souza", c3: "carla.souza@empresa.com", c4: "TI", c5: "2024-06-25" },
        { c1: "104", c2: "Diego Lima", c3: "diego.lima@empresa.com", c4: "Comercial", c5: "2024-07-15" },
      ]
    };

    const container = document.getElementById("tableContainer");
    const addRowBtn = document.getElementById("addRow");
    const addColBtn = document.getElementById("addColumn");
    const clearBtn = document.getElementById("clearTable");

    let sortState = { index: null, direction: null };

    function renderTable() {
      container.innerHTML = "";
      const table = document.createElement("table");
      const thead = document.createElement("thead");
      const tbody = document.createElement("tbody");
      const headerRow = document.createElement("tr");

      tableData.headers.forEach((header, i) => {
        const th = document.createElement("th");
        const input = document.createElement("input");
        input.value = header;
        input.dataset.index = i;

        // impedir que o click para editar dispare o sort
        input.addEventListener("click", e => e.stopPropagation());
        input.addEventListener("input", e => {
          tableData.headers[e.target.dataset.index] = e.target.value;
          pushToSquidex();
        });

        if (sortState.index === i) {
          th.classList.add(sortState.direction === "asc" ? "sort-asc" : "sort-desc");
        }

        th.appendChild(input);
        th.addEventListener("click", () => sortTable(i));
        headerRow.appendChild(th);
      });

      thead.appendChild(headerRow);
      table.appendChild(thead);

      tableData.rows.forEach((row, rIndex) => {
        const tr = document.createElement("tr");
        tableData.headers.forEach((_, cIndex) => {
          const td = document.createElement("td");
          const input = document.createElement("input");
          const key = `c${cIndex + 1}`;
          input.value = row[key] || "";
          input.dataset.row = rIndex;
          input.dataset.col = key;
          input.addEventListener("input", e => {
            tableData.rows[e.target.dataset.row][e.target.dataset.col] = e.target.value;
            pushToSquidex();
          });
          td.appendChild(input);
          tr.appendChild(td);
        });
        tbody.appendChild(tr);
      });

      table.appendChild(tbody);
      container.appendChild(table);
    }

    function sortTable(index) {
      const key = `c${index + 1}`;
      if (sortState.index === index) {
        sortState.direction = sortState.direction === "asc" ? "desc" : "asc";
      } else {
        sortState = { index, direction: "asc" };
      }
      tableData.rows.sort((a, b) => {
        if (a[key] < b[key]) return sortState.direction === "asc" ? -1 : 1;
        if (a[key] > b[key]) return sortState.direction === "asc" ? 1 : -1;
        return 0;
      });
      renderTable();
    }

    function pushToSquidex() {
      if (field) field.valueChanged(tableData);
    }

    addRowBtn.addEventListener("click", () => {
      const newRow = {};
      for (let i = 1; i <= tableData.headers.length; i++) newRow[`c${i}`] = "";
      tableData.rows.push(newRow);
      renderTable();
      pushToSquidex();
    });

    addColBtn.addEventListener("click", () => {
      tableData.headers.push(`Nova Coluna ${tableData.headers.length + 1}`);
      tableData.rows.forEach(r => (r[`c${tableData.headers.length}`] = ""));
      renderTable();
      pushToSquidex();
    });

    clearBtn.addEventListener("click", () => {
      if (confirm("Deseja limpar todos os dados da tabela?")) {
        tableData.rows = [];
        renderTable();
        pushToSquidex();
      }
    });

    if (field) {
      field.onValueChanged(value => {
        if (value && value.headers && value.rows) {
          tableData = value;
          renderTable();
        }
      });
      field.onDisabled(disabled => {
        addRowBtn.disabled = disabled;
        addColBtn.disabled = disabled;
        clearBtn.disabled = disabled;
      });
    }

    renderTable();
  </script>
</body>
</html>
