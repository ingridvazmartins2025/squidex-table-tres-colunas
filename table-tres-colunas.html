<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Tabela Interativa Squidex</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="./editor-sdk.js"></script>
  <style>
    body {
      font-family: "Inter", sans-serif;
      margin: 20px;
      background-color: #f8fafc;
    }

    h2 {
      color: #1e3a8a;
      margin-bottom: 16px;
    }

    .controls {
      margin-bottom: 12px;
    }

    button {
      background-color: #2563eb;
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 6px;
      margin-right: 6px;
      cursor: pointer;
    }

    button:hover {
      background-color: #1d4ed8;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      border: 1px solid #d1d5db;
      background-color: white;
      border-radius: 8px;
      overflow: hidden;
    }

    thead {
      background-color: #e8f0ff;
      color: #1e3a8a;
    }

    th, td {
      border: 1px solid #d1d5db;
      padding: 8px;
      text-align: left;
    }

    th {
      position: relative;
      cursor: pointer;
      user-select: none;
      font-weight: 600;
    }

    th input {
      width: 90%;
      border: none;
      background: transparent;
      font-weight: 600;
      color: #1e3a8a;
    }

    th input:focus {
      outline: none;
      background-color: #dbeafe;
    }

    td input {
      width: 100%;
      border: none;
      background: transparent;
      color: #111827;
    }

    td input:focus {
      outline: none;
      background-color: #eef2ff;
    }

    tr:nth-child(even) {
      background-color: #f9fafb;
    }

    th.sort-asc::after {
      content: " ⬆️";
    }

    th.sort-desc::after {
      content: " ⬇️";
    }
  </style>
</head>
<body>
  <h2>Tabela Interativa (Squidex)</h2>
  <div class="controls">
    <button id="addColumn">Adicionar Coluna</button>
    <button id="addRow">Adicionar Linha</button>
    <button id="clearTable">Limpar Tudo</button>
  </div>

  <div id="tableContainer"></div>

  <script>
    let field;
    try { field = new SquidexFormField(); } catch (e) { console.warn("Rodando fora do Squidex"); }

    let tableData = {
      headers: ["Header 1", "Header 2", "Header 3", "Header 4", "Header 5"],
      rows: [
        { c1: "0", c2: "Mon Jan 29 2024 17:04:30 GMT+0000", c3: "2a7d90e8-75d7-4717-a748-b872abbd5e6b", c4: "80ed6bcb-3e28-4f18-b20e-6f8b2c1aa603", c5: "ae4dd5d9-4329-489b-998e-2ea175f3bb21" },
        { c1: "16", c2: "Wed Jan 17 2024 15:43:39 GMT+0000", c3: "eacd860b-15d1-4820-9d21-23791bb2436f", c4: "626a6d5e-8afa-4bf0-a54b-526045fd9cf0", c5: "a353b57b-e08c-4ccd-9453-909cbca57a8a" },
        { c1: "5", c2: "Thu Jan 11 2024 11:16:40 GMT+0000", c3: "50834fa9-7fb8-4381-aaea-ba321a29887e", c4: "6278cedd-89fe-4790-82d5-77d98bb6bde9", c5: "5753d747-4e64-4c62-9117-0a7ead999dc4" },
      ]
    };

    const container = document.getElementById("tableContainer");
    const addRowBtn = document.getElementById("addRow");
    const addColBtn = document.getElementById("addColumn");
    const clearBtn = document.getElementById("clearTable");

    let sortState = { index: null, direction: null };

    function renderTable() {
      container.innerHTML = "";
      const table = document.createElement("table");
      const thead = document.createElement("thead");
      const tbody = document.createElement("tbody");
      const headerRow = document.createElement("tr");

      tableData.headers.forEach((header, i) => {
        const th = document.createElement("th");
        const input = document.createElement("input");
        input.value = header;
        input.dataset.index = i;
        input.addEventListener("input", e => {
          tableData.headers[e.target.dataset.index] = e.target.value;
          pushToSquidex();
        });

        if (sortState.index === i) {
          th.classList.add(sortState.direction === "asc" ? "sort-asc" : "sort-desc");
        }

        th.appendChild(input);
        th.addEventListener("click", () => sortTable(i));
        headerRow.appendChild(th);
      });

      thead.appendChild(headerRow);
      table.appendChild(thead);

      tableData.rows.forEach((row, rIndex) => {
        const tr = document.createElement("tr");
        tableData.headers.forEach((_, cIndex) => {
          const td = document.createElement("td");
          const input = document.createElement("input");
          const key = `c${cIndex + 1}`;
          input.value = row[key] || "";
          input.dataset.row = rIndex;
          input.dataset.col = key;
          input.addEventListener("input", e => {
            tableData.rows[e.target.dataset.row][e.target.dataset.col] = e.target.value;
            pushToSquidex();
          });
          td.appendChild(input);
          tr.appendChild(td);
        });
        tbody.appendChild(tr);
      });

      table.appendChild(tbody);
      container.appendChild(table);
    }

    function sortTable(index) {
      const key = `c${index + 1}`;
      if (sortState.index === index) {
        sortState.direction = sortState.direction === "asc" ? "desc" : "asc";
      } else {
        sortState = { index, direction: "asc" };
      }
      tableData.rows.sort((a, b) => {
        if (a[key] < b[key]) return sortState.direction === "asc" ? -1 : 1;
        if (a[key] > b[key]) return sortState.direction === "asc" ? 1 : -1;
        return 0;
      });
      renderTable();
    }

    function pushToSquidex() {
      if (field) field.valueChanged(tableData);
    }

    addRowBtn.addEventListener("click", () => {
      const newRow = {};
      for (let i = 1; i <= tableData.headers.length; i++) newRow[`c${i}`] = "";
      tableData.rows.push(newRow);
      renderTable();
      pushToSquidex();
    });

    addColBtn.addEventListener("click", () => {
      tableData.headers.push(`Header ${tableData.headers.length + 1}`);
      tableData.rows.forEach(r => (r[`c${tableData.headers.length}`] = ""));
      renderTable();
      pushToSquidex();
    });

    clearBtn.addEventListener("click", () => {
      tableData.rows = [];
      renderTable();
      pushToSquidex();
    });

    if (field) {
      field.onValueChanged(value => {
        if (value && value.headers && value.rows) {
          tableData = value;
          renderTable();
        }
      });
      field.onDisabled(disabled => {
        addRowBtn.disabled = disabled;
        addColBtn.disabled = disabled;
        clearBtn.disabled = disabled;
      });
    }

    renderTable();
  </script>
</body>
</html>
